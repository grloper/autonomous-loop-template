name: Workflow Doctor - Auto-Fix Failures

on:
  workflow_run:
    workflows: 
      - "🎯 Orchestrator - Autonomous Project Lead"
      - "🤖 Copilot Auto-Assign & Auto-Review"
    types: 
      - completed
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Workflow run ID to diagnose (optional - will use latest failure)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  diagnose-and-fix:
    # Only run if workflow ACTUALLY failed (not action_required from draft PRs)
    if: |
      (github.event.workflow_run.conclusion == 'failure' || github.event_name == 'workflow_dispatch') &&
      github.event.workflow_run.conclusion != 'action_required'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install PyGithub requests pyyaml
      
      - name: Run Workflow Doctor
        id: doctor
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python .github/scripts/workflow_doctor.py \
            --repo "${{ github.repository }}" \
            --run-id "${{ github.event.workflow_run.id || inputs.run_id }}" \
            --workflow-name "${{ github.event.workflow_run.name }}"
      
      - name: Create Fix PR (if auto-fix available)
        if: steps.doctor.outputs.auto_fix_available == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config user.name "Workflow Doctor Bot"
          git config user.email "workflow-doctor@github.com"
          
          # Create fix branch
          BRANCH_NAME="auto-fix/workflow-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          
          # Apply fixes (already done by workflow_doctor.py)
          git add .
          git commit -m "fix: Auto-fix workflow failure - ${{ steps.doctor.outputs.issue_type }}"
          
          # Push and create PR
          git push origin "$BRANCH_NAME"
          
          gh pr create \
            --title "🤖 Auto-Fix: ${{ steps.doctor.outputs.issue_type }}" \
            --body "${{ steps.doctor.outputs.pr_body }}" \
            --label "automated-fix,workflow-doctor" \
            --base main \
            --head "$BRANCH_NAME"
      
      - name: Create Issue (if manual review needed)
        if: steps.doctor.outputs.auto_fix_available == 'false' || failure()
        uses: actions/github-script@v7
        with:
          script: |
            const diagnosis = `${{ steps.doctor.outputs.diagnosis }}` || 'Workflow Doctor analysis in progress...';
            const recommendations = `${{ steps.doctor.outputs.recommendations }}` || 'Review workflow logs manually';
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `🔧 Workflow Failure: ${{ github.event.workflow_run.name || 'Unknown Workflow' }}`,
              body: `## Workflow Doctor Diagnosis
              
              **Workflow**: ${{ github.event.workflow_run.name || 'Unknown' }}
              **Run ID**: ${{ github.event.workflow_run.id || inputs.run_id || 'Unknown' }}
              **Run URL**: ${{ github.event.workflow_run.html_url || 'N/A' }}
              **Conclusion**: ${{ github.event.workflow_run.conclusion || 'failure' }}
              
              ## Diagnosis
              ${diagnosis}
              
              ## Recommendations
              ${recommendations}
              
              ## Next Steps
              - Review the failed workflow logs at the URL above
              - Check for deprecated actions (upgrade to v4)
              - Verify workflow syntax
              - Test fixes in a separate branch
              
              ## Common Fixes
              - **Deprecated actions**: Update \`actions/upload-artifact@v3\` to \`@v4\`
              - **Permissions**: Add proper \`permissions:\` block
              - **Dependencies**: Check \`requirements.txt\` is complete
              
              ---
              _Auto-generated by Workflow Doctor 🏥_`,
              labels: ['workflow-failure', 'needs-review', 'automated-diagnosis']
            });
      
      - name: Generate Summary
        run: |
          echo "## 🏥 Workflow Doctor Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Failed Workflow**: ${{ github.event.workflow_run.name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID**: ${{ github.event.workflow_run.id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Auto-fix Available**: ${{ steps.doctor.outputs.auto_fix_available }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Diagnosis" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.doctor.outputs.diagnosis }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.doctor.outputs.auto_fix_available }}" == "true" ]; then
            echo "✅ **Auto-fix applied** - PR created with recommended changes" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **Manual review required** - Issue created for human intervention" >> $GITHUB_STEP_SUMMARY
          fi
